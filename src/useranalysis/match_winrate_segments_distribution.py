import os
import pandas as pd
import matplotlib.pyplot as plt


def plot_match_winrate_user_distribution(
    save_path="../outputs/figurestask2/match_winrate_user_distribution.png",
):

    df = pd.DataFrame(
        {
            "match_segment": [
                "1 match",
                "1 match",
                "2-3 matches",
                "2-3 matches",
                "2-3 matches",
                "2-3 matches",
                "4-7 matches",
                "4-7 matches",
                "4-7 matches",
                "4-7 matches",
                "8-15 matches",
                "8-15 matches",
                "8-15 matches",
                "8-15 matches",
                "16-30 matches",
                "16-30 matches",
                "16-30 matches",
                "16-30 matches",
                "30+ matches",
                "30+ matches",
                "30+ matches",
                "30+ matches",
            ],
            "win_segment": [
                "0-25%",
                "76-100%",
                "0-25%",
                "26-50%",
                "51-75%",
                "76-100%",
                "0-25%",
                "26-50%",
                "51-75%",
                "76-100%",
                "0-25%",
                "26-50%",
                "51-75%",
                "76-100%",
                "0-25%",
                "26-50%",
                "51-75%",
                "76-100%",
                "0-25%",
                "26-50%",
                "51-75%",
                "76-100%",
            ],
            "users": [
                88381,
                41020,
                89133,
                31864,
                299013,
                42767,
                3493,
                6883,
                70483,
                182251,
                502,
                2201,
                43337,
                89729,
                93,
                1977,
                12880,
                11266,
                38,
                603,
                2127,
                36818,
            ],
            "d1_retention": [
                0.17924667066450969,
                0.21233544612384167,
                0.17008290980893712,
                0.25869319608335478,
                0.22455879844689139,
                0.30308415366988506,
                0.23675923275121691,
                0.42859218364085433,
                0.45145637955251716,
                0.41327619601538834,
                0.32071713147410352,
                0.59563834620627,
                0.59018852250963361,
                0.57455226292503014,
                0.70967741935483863,
                0.73899848254931777,
                0.75628881987577656,
                0.738327711698917,
                0.84210526315789469,
                0.87396351575456022,
                0.85143394452280208,
                0.1795589114020317,
            ],
            "d3_retention": [
                0.056380896346499836,
                0.0706240858117991,
                0.054446725679602209,
                0.090289982425307391,
                0.081361011059719782,
                0.10739588935394122,
                0.07701116518751791,
                0.16446317012930389,
                0.16233701743682832,
                0.1507207093513899,
                0.15537848605577689,
                0.27623807360290753,
                0.24422548861250165,
                0.23400461389294352,
                0.31182795698924726,
                0.42640364188163887,
                0.39231366459627359,
                0.3718267353097815,
                0.60526315789473684,
                0.53399668325041472,
                0.53972731546779518,
                0.06200771361833899,
            ],
            "d7_retention": [
                0.024303866215589304,
                0.029132130667966844,
                0.023481763207790572,
                0.040076575445644046,
                0.035560326808533556,
                0.040685575326770557,
                0.033495562553678783,
                0.062618044457358718,
                0.069080487493438036,
                0.0646196728687361,
                0.049800796812749,
                0.12812358019082251,
                0.11110598333987108,
                0.10925118969341015,
                0.15053763440860218,
                0.22104198280222556,
                0.20729813664596275,
                0.20459790520149135,
                0.31578947368421051,
                0.30348258706467662,
                0.34226610249177253,
                0.029496441957738064,
            ],
            "d14_retention": [
                0.0094137880313641571,
                0.010312042905899549,
                0.0089080363052965617,
                0.015597539543058023,
                0.014514419105523813,
                0.014660836626370804,
                0.013169195533925001,
                0.02571553101845131,
                0.0269426670260914,
                0.025942244486998594,
                0.019920318725099605,
                0.052248977737392059,
                0.041673396866419049,
                0.048100391177879988,
                0.06451612903225809,
                0.093576125442589836,
                0.10155279503105592,
                0.1127285638203445,
                0.15789473684210528,
                0.14925373134328362,
                0.19370004701457444,
                0.012385246346895529,
            ],
        }
    )

    match_order = [
        "1 match",
        "2-3 matches",
        "4-7 matches",
        "8-15 matches",
        "16-30 matches",
        "30+ matches",
    ]
    win_order = ["0-25%", "26-50%", "51-75%", "76-100%"]

    pivot = (
        df.pivot(index="match_segment", columns="win_segment", values="users")
        .reindex(index=match_order, columns=win_order)
    )

    fig, ax = plt.subplots(figsize=(12, 7))

    pivot.plot(
        kind="bar",
        stacked=True,
        ax=ax,
        colormap="tab20",
        edgecolor="black",
    )

    ax.set_title(
        "User Distribution by D0 Matches Played and Win Rate Segment", fontsize=16
    )
    ax.set_xlabel("D0 Match Segment", fontsize=12)
    ax.set_ylabel("Users", fontsize=12)
    ax.legend(title="Win Rate Segment", fontsize=10)
    ax.grid(axis="y", alpha=0.3)

    plt.tight_layout()

    out_dir = os.path.dirname(save_path)
    if out_dir and not os.path.exists(out_dir):
        os.makedirs(out_dir, exist_ok=True)

    plt.savefig(save_path, dpi=150, bbox_inches="tight")
    plt.show()

